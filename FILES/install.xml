<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>iCeP Add Default Address - Simplied checkout</name>
    <code>iCePDefaultAddressSimplifiedCheckout</code>
    <version>2.0.0</version>
    <author>volyminhnhan@gmail.com</author>

    <file path="catalog/controller/account/register.php">
        <operation info="Add default Address for normal registration" error="log">
            <search><![CDATA[$customer_id = $this->model_account_customer->addCustomer($this->request->post);]]></search>
            <add position="replace"><![CDATA[
                //start volyminhnhan@gmail.com modifications
                //setup address array data for insert as default, for Phase 1 - address will be NONE
                $address = array();
                $address['firstname'] = $this->request->post['firstname'];
                $address['lastname'] = $this->request->post['lastname'];
                $address['company'] = 'NOT PROVIDED';
                $address['address_1'] = 'NOT PROVIDED';
                $address['address_2'] = 'NOT PROVIDED';
                $address['city'] = 'NOT PROVIDED';
                $address['postcode'] = 'NOT PROVIDED';
                $address['country_id'] = 230;
                $address['zone_id'] = 3780;//all are HCMC in Phase 1
                $address['default'] = true;//default address

                $post_data = $this->request->post;
                $post_data['address'][] = $address;
                $customer_id = $this->model_account_customer->addCustomer($post_data);
                //end volyminhnhan@gmail.com modifications
                ]]></add>
        </operation>
    </file>
    
    <file path="catalog/controller/extension/module/ajaxregister.php">
        <operation info="Add default Address for popup registration" error="log">
            <search><![CDATA[$customer_id = $this->model_account_customer->addCustomer($this->request->post);]]></search>
            <add position="replace"><![CDATA[
                //start volyminhnhan@gmail.com modifications
                //setup address array data for insert as default, for Phase 1 - address will be NONE
                $address = array();
                $address['firstname'] = $this->request->post['firstname'];
                $address['lastname'] = $this->request->post['lastname'];
                $address['company'] = 'NOT PROVIDED';
                $address['address_1'] = 'NOT PROVIDED';
                $address['address_2'] = 'NOT PROVIDED';
                $address['city'] = 'NOT PROVIDED';
                $address['postcode'] = 'NOT PROVIDED';
                $address['country_id'] = 230;
                $address['zone_id'] = 3780;//all are HCMC in Phase 1
                $address['default'] = true;//default address

                $post_data = $this->request->post;
                $post_data['address'][] = $address;
                $customer_id = $this->model_account_customer->addCustomer($post_data);
                //end volyminhnhan@gmail.com modifications
                ]]></add>
        </operation>
    </file>

    <file path="catalog/model/account/customer.php">
        <operation info="Add default Address for registration model" error="log">
            <search><![CDATA[$customer_id = $this->db->getLastId();]]></search>
            <add position="after"><![CDATA[
                //start volyminhnhan@gmail.com modifications
                if (isset($data['address'])) {
                    foreach ($data['address'] as $address) {
                        $this->db->query("INSERT INTO " . DB_PREFIX . "address SET customer_id = '" . (int)$customer_id . "', firstname = '" . $this->db->escape($address['firstname']) . "', lastname = '" . $this->db->escape($address['lastname']) . "', company = '" . $this->db->escape($address['company']) . "', address_1 = '" . $this->db->escape($address['address_1']) . "', address_2 = '" . $this->db->escape($address['address_2']) . "', city = '" . $this->db->escape($address['city']) . "', postcode = '" . $this->db->escape($address['postcode']) . "', country_id = '" . (int)$address['country_id'] . "', zone_id = '" . (int)$address['zone_id'] . "', custom_field = '" . $this->db->escape(isset($address['custom_field']) ? json_encode($address['custom_field']) : json_encode(array())) . "'");

                        if (isset($address['default'])) {
                            $address_id = $this->db->getLastId();

                            $this->db->query("UPDATE " . DB_PREFIX . "customer SET address_id = '" . (int)$address_id . "' WHERE customer_id = '" . (int)$customer_id . "'");
                        }
                    }
                }
                //end volyminhnhan@gmail.com modifications
                ]]></add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/checkout.twig">
        <operation info="Mark the last block as keep first" error="log">
            <search trim="true"><![CDATA[<h4 class="panel-title">{{ text_checkout_confirm }}</h4>]]></search>
            <add position="replace" trim="true" offset="-2"><![CDATA[
        <div class="panel panel-default vlmn-checkout-confirmation">
            <div class="panel-heading">
                <h4 class="panel-title">{{ text_checkout_confirm }}</h4>
                 ]]></add>
        </operation>

        <operation info="Hide relevant blocks" error="log">
            <search><![CDATA[<div class="panel panel-default">]]></search>
            <add position="replace"><![CDATA[
               <div class="panel panel-default" style="display:none;">
                ]]></add>
        </operation>

        <operation info="Call checkout confirmation when ready" error="log">
            <search><![CDATA[$('a[href=\'#collapse-payment-address\']').trigger('click');]]></search>
            <add position="after"><![CDATA[
               $.ajax({
                    url: 'index.php?route=checkout/confirm',
                    dataType: 'html',
                    complete: function() {
                        $('#button-payment-method').button('reset');
                    },
                    success: function(html) {
                        $('#collapse-checkout-confirm .panel-body').html(html);

                        $('#collapse-checkout-confirm').find('.panel-heading .panel-title').parent().html('<a href="#collapse-checkout-confirm" data-toggle="collapse" data-parent="#accordion" class="accordion-toggle">{{ text_checkout_confirm }} <i class="fa fa-caret-down"></i></a>');

                        $('a[href=\'#collapse-checkout-confirm\']').trigger('click');
                        $('#collapse-checkout-confirm').addClass("in");
                    },
                    error: function(xhr, ajaxOptions, thrownError) {
                        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
                    }
                });
                ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/checkout.php">
        <operation info="Set default value for Checkout" error="log">
            <search trim="true"><![CDATA[public function index() {]]></search>
            <add position="after" trim="true"><![CDATA[
                //get customer id
                $this->customer = new Cart\Customer($this->registry);
                if (!$this->customer->isLogged()) {
                    $this->session->data['redirect_url'] = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
                    $this->response->redirect($this->url->link('account/login', '', true));
                }
                
                 ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/account/login.php">
        <operation info="Set default value for Checkout" error="log">
            <search trim="true"><![CDATA[if (isset($this->request->post['redirect']) && $this->request->post['redirect'] != $this->url->link('account/logout', '', true) && (strpos($this->request->post['redirect'], $this->config->get('config_url')) !== false || strpos($this->request->post['redirect'], $this->config->get('config_ssl')) !== false)) {]]></search>
            <add position="before" trim="true"><![CDATA[
                if(isset($this->session->data['redirect_url'])) {
                    $url = $this->session->data['redirect_url'];
                    unset($this->session->data['redirect_url']);
                    $this->response->redirect(str_replace('&amp;', '&', $url));
                }
                
                 ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/confirm.php">
        <operation info="Set default value for Checkout" error="log">
            <search trim="true"><![CDATA[$redirect = '';]]></search>
            <add position="after" trim="true"><![CDATA[
                //get customer id
                $this->customer = new Cart\Customer($this->registry);
                $this->load->model('customer/customer');

                $addresses = $this->model_customer_customer->getAddresses($this->customer->getId());
                $addresses = array_values($addresses);
                $address = $addresses[0];

                //set shipping address with default address
                $this->session->data['shipping_address'] = $this->model_customer_customer->getAddress((int)$address['address_id']);

                //set payment address with default address
                $this->session->data['payment_address'] = $this->model_customer_customer->getAddress((int)$address['address_id']);

                //set comment null
                $this->session->data['comment'] = '';

                //set shipping method
                $shipping_method = array();
                $shipping_method['code'] = "flat.flat";
                $shipping_method['title'] = "Phí ship";
                $shipping_method['cost'] = "0.00";
                $shipping_method['tax_class_id'] = "9";
                $shipping_method['text'] = "0VNĐ";
                $this->session->data['shipping_method'] = $shipping_method;

                //set payment method
                $payment_method = array();
                $payment_method['code'] = "cod";
                $payment_method['title'] = "Trả tiền khi nhận hàng";
                $payment_method['terms'] = "";
                $payment_method['sort_order'] = "0";
                $this->session->data['payment_method'] = $payment_method;
                 ]]></add>
        </operation>
    </file>
</modification>